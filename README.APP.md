Инструкция по работе с проектом
============================

1. [Описание проекта](#descr)
2. [Репозиторий верстки](#repo)
3. [Разворачивание проекта локально](#install)
4. [Ведение кода в git](#git)
5. [Работа с задачами ](#tasks)
6. [Рекоммендации по работе со стилями](#css)
7. [Рекоммендации по работае с js](#js)
8. [Верстка с учетом особенностей фреймворка](#framework)

<a id="descr"></a>
## 1. Описание проекта

Проект DSZN включает в себя две части:

[Сайт департамента труда и соцзащиты](https://dszn.ru)  
[Социальный навигатор](https://dszn.ru)

Обе части являюся самостоятельными проектам, развернутыми на отдельных площадках

### Сайт департамента труда и соцзащиты

Исходники gitlab: https://gitlab.dev-vps.ru/dtszn/master

Продакшн сервер: https://dszn.ru

Тестовывые сервера:  
*Основной*: https://dtszn.dev-vps.ru  
*Альтернативный*: https://heirarchy.dtszn.dev-vps.ru  

Альтернативный тестовый сервер привязан к ветке *heirarchy* и используется ситуативно для реализации больших задач, в параллель к текущим.

В сайт разделен на публичную часть, панель администрирования и личный кабинет пользователя.

*Публичная часть*: https://dszn.ru  
*Панель администрирования*: https://dszn.ru/cp  
*Личный кабинет*: https://dszn.ru/subordinate/cabinet/default/login  

### Социальный навигатор

Исходники gitlab: https://gitlab.dev-vps.ru/dtszn/sndtszn

*Продакшн сервер*: https://nav.dszn.ru  
*Тестовый сервер*: https://sndtszn.dev-vps.ru  
*Панель администрирования*: https://nav.dszn.ru/cp  

<a id="repo"></a>
## 2. Репозиторий верстки

Для реализации верстки есть отдельный репозиторий:

Исходники **gitlab**: https://gitlab.dev-vps.ru/dtszn/html

Тестовый сервер: https://dtszn.dev-vps.ru/html/dist/front-page3.html

В репо верстки два раздела

*Публичная часть*:   
https://gitlab.dev-vps.ru/dtszn/html/-/tree/master/html/dist

*Личный кабинет*:   
https://gitlab.dev-vps.ru/dtszn/html/-/tree/master/html/lk  

Стили и скрипты публичной части и личного кабинета не пересекаются.

Если правки стилей или скриптов осуществляются напрямую в проекте (https://gitlab.dev-vps.ru/dtszn/master) - все изменения должны быть синхронизированы в репо верстки.

<a id="install"></a>
## 3. Разворачивание проекта локально

Предполагается что в системе уже установлен docker и docker-compose

### 3.1 Клонирование проекта

```
git clone --progress -v "https://gitlab.dev-vps.ru/gpn/master.git" "c:\projects\dtszn\master"
```
где *c:\projects\dtszn* - локальный путь к проекту

### 3.2 Настройка проекта

Копируем файл настройки окружения:

```
cp .env.dist .env
```

Редактируем файл .env

Основные параметры:

```
COMPOSE_PROJECT_NAME=cmf2 _ИМЯ_ПРОЕКТА_

CONTAINER_NAME=cmf2 _ИМЯ_ПРОЕКТА_

APACHE_RUN_ID=1000 _ID_ЛОКАЛЬНОГО_ПОЛЬЗОВАТЕЛЯ_
APACHE_RUN_USER=krok _ИМЯ_ЛОКАЛЬНОГО_ПОЛЬЗОВАТЕЛЯ_
APACHE_RUN_GROUP=krok _ГРУППА_ЛОКАЛЬНОГО_ПОЛЬЗОВАТЕЛЯ_
```

Остальные параметры можно оставить без изменения

### 3.3 Запуск контейнеров

Запускаем контейнеры:

```
docker-compose up -d
```

Если контейнеров в системе нет они будут загружены ( ~2 GB ) .

После первого запуска нужно подождать 2-3 минуты , это нужно для первой инициализации

Проверяем запущенные контейнеры:

```
docker-compose ps
```

Остановка контейнеров:

```
docker-compose down
```

### 3.4 Установка системы

```
./docker.sh install
```

### 3.5 Полезные команды

#### Установка / обновление composer  
```
./docker.sh exec composer --working-dir=framework install
./docker.sh exec composer --working-dir=framework update
```

#### Развернуть дамп базы данных

Положить файл с дампом (latest.sql.gz) в папку docker/backup, затем
```
./docker.sh mysql-restore
```

#### Запустить миграции

```
./docker.sh exec framework/yii migrate/up
```

#### Раздать права доступа

```
./docker.sh exec framework/yii access/install
```

#### Очистить кеш

```
./docker.sh exec framework/yii cache/flush-all
```

<a id="git"></a>
## 4. Ведение кода в git

### 4.1 Основные положения:
Одна задача >> Один коммит >> Одна ветка >> Один Мердж

### 4.2 Создание ветки
Перед тем, как сделать коммит стягиваем пулл и далее делаем новую ветку
```
git pull
git checkout #newbranch
```

### 4.3 Наименование ветки
В случае если коммит выполняется в рамках задачи, то:  
**# + $Номер задачи + (“пусто” или /fix или /rework или /refactoring или /review)**

Примеры: 

***#99999*** – ветка для вновь реализуемой задачи  
***#99999/rework*** – ветка доработок реализуемой задачи для подзадач с тегами #rework  
***#99999/fix*** – ветка исправления багов по реализованной задаче  
***#99999/texts*** – ветка исправления контента по реализованной задаче - (нежелательные коммиты)  
***#99999/refactoring*** – ветка рефакторинга по уже реализованной задаче - (нежелательные коммиты, лучше fix)  

В случае если коммит выполняется без задачи (срочные и нежелательные коммиты), то:  
**#no-task + ( /hot-fix или /texts или /refactoring или /infra или /other)**

Примеры:  
```
#no-task/hot-fix -  ветка для срочного фикса, когда нет времени проводить задачу по таск-трекеру  
#no-task/texts - ветка для мелких правок по тексту, когда нет времени проводить задачу по таск-трекеру  
#no-task/refactoring – ветка для небольшого рефакторинга кода, когда нет времени проводить задачу по таск-трекеру  
#no-task/other – ветка для других исправлений: все что не подпадает под другие категории, но сделанное без задачи    
```

### 4.4 Наименование коммита:
-- Наименование ветки, созданное согласно правилам из п.4.3
-- “-“
-- Наименование задачи из таск-трекера

Примеры:
```
#99990 - Диагностическая карта участника - Доработка импорта дополнительных Показателей (HH HR)  
#99991/fix - Развитие/ЛК Пользователя - Проверка отображения баллов в Диагностической анкете(HH HR)
```

### 4.5 Тело описания коммита
Дублируем полное наименование коммита  
Ссылка на задачу по коммиту  
Описание изменений, выполненных подзадач  

Пример:
```
#99990 - Диагностическая карта участника. Доработка импорта дополнительных Показателей (HH HR)
https://nsign.bitrix24.ru/extranet/contacts/personal/user/1398/tasks/task/view/99990/
1. Выполнена задача по импортированию данных оценки от Заказчика (раздел Кабинет-Пользователь кнопка "Импорт") #nework
2. Разработан метод сохранения данных в таблицу cmf2_client_rating, которая связана с активным (неархивным) откликом #nework
```

<a id="tasks"></a>
## 5. Работа с задачами
При работе с задачами нужно в комментариях к задаче оставлять ссылку на мерж реквест.

<a id="css"></a>
## 6. Рекоммендации по работе со стилями
В проекте существует разделение стилей лк и публичной части. В репо верстки для этого заведены отдельные билды

*Публичная часть*:   
https://gitlab.dev-vps.ru/dtszn/html/-/tree/master/html/dist  
*Личный кабинет*:   
https://gitlab.dev-vps.ru/dtszn/html/-/tree/master/html/lk  

Нельзя верстать страницы для лк в *dist* - стили и скрипты из публичной части не могут быть применены в лк.

При верстке нужно иметь в виду, что почти все что есть на сайте - динамический контент, то есть вносится через *панель администрирования*.

Макет не является отражением действительности. Элементов в списках может быть, как больше, так и меньше, чем отображено на макете - верстка должна это учитывать.  

Иконки и другие графические элементы - тоже чаще всего загружаемые, это нужно учитывать при выводе и регулировании размера графического элемента.

>**ВАЖНО!**   
>Если при срочных правках, что-то правится в ***main.css*** напрямую в основном проекте (без репо верстки) - необходимо эти правки синхронизировать в репо верстки.  
Минифицированная версия ***main.min.css***, при срочных правках напрямую, также обязательно должна быть актуализирована.

<a id="js"></a>
## 7. Рекоммендации по работае с js
Декоративную часть *js* пишет верстальщик, функциональную программист.

Если в блоке присуствуют обработчики кликов по ссылкам или кнопкам 
(например требуется после клика преключить класс элемента) - по возможности 
нужно избегать использования ``e.preventDefault()``, поскольку на этот же клик бывает необходимо добавить дополнительный функционал.

Используйте конструкцию ``$(document).on(...)`` при добавлении обработчиков.  
Например:  
``$(document).on('click', '.my-class', function() {})``  
вместо   
``$('.my-class').click(function() {})``

Зачастую, блоки подгружаются через *ajax* и конструкция ``$('.my-class').click(...)`` не будет работать после динамической загрузки блока без объявления обработчика заново.

Если пишете скрипт для большого автономного блока, котрый предполагает манипулирование данными из бэкграунда - лучше этот скрипт вынести в отдельный *js* файл, 
который будет подключен только на нужной странице.   
С вероятностью 100% программисту понадобится написать свои обработчики событий и, 
чтобы не лезть в ***main.js*** и, затем, не синхронизировать скрипты репо верстки 
с измененым в ходе работы ***main.js*** основного проекта - лучше такой интерактив выносить из общего ***main.js***.

>**ВАЖНО!**  
> Если при срочных правках, что-то правится в **main.js** напрямую в основном проекте (без репо верстки) - необходимо эти правки синхронизировать в репо верстки.
Минифицированная версия main.min.js, при срочных правках напрямую, также обязательно должна быть актуализирована.

<a id="framework"></a>
## 8. Верстка с учетом особенностей фреймворка
При значительных изменениях в дизайне страниц (напрмер, когда меняются ключевые элементы страницы: 
хедер, футер, breadcrumbs, кнопки "Печать" и "Поделиться"), необходимо согласовать с программистом вложенность контейнеров.  
В проекте есть шаблоны страниц, в которых зафиксированы общие элементы и крайне нежелательно заносить их в контейнер контентной части.

Есть особенности и при работе с *формами*. Формы фреймфорка являются автогенерируемыми - при верстке форм желательно наличие 
определенного набора контейнеров и соблюдение порядка их вложенности.
